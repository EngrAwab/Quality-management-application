{% extends "layout.html" %}
{% block page_heading %}Image Analysis{% endblock %}
{% block content %}
<div class="card shadow-lg mb-4 custom-card">
  <!-- Card Body -->
  <div class="card-body">
    <!-- Analysis Controls -->
    <form method="POST" class="mb-4">
      <div class="row g-3 align-items-center">
        <div class="col-md-4">
          <label for="analysis_type" class="form-label fw-bold">Select Analysis Type</label>
          <select class="form-select form-select-lg" id="analysis_type" name="analysis_type" required>
            <option value="" selected disabled>Choose analysis method</option>
            <option value="Manual">Manual Analysis</option>
            <option value="Automatic">Automatic Analysis</option>
            <option value="AI">AI Analysis</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="altitude" class="form-label fw-bold">Altitude (mm)</label>
          <input type="range" class="form-range" min="0" max="600" step="5" id="altitude" name="altitude" 
                 oninput="document.getElementById('altitude_val').innerText=this.value">
          <span id="altitude_val" class="fw-bold">300</span>
        </div>
        <div class="col-md-4">
          <label for="angle" class="form-label fw-bold">Angle (Â°)</label>
          <input type="range" class="form-range" min="0" max="80" step="5" id="angle" name="angle" 
                 oninput="document.getElementById('angle_val').innerText=this.value">
          <span id="angle_val" class="fw-bold">40</span>
        </div>
      </div>
      <div class="text-center mt-3">
        <button type="submit" class="btn btn-warning btn-custom">Start Analysis</button>
      </div>
    </form>
    <!-- End Analysis Controls -->

    <!-- Images Section: Two Parallel Columns -->
    <div class="row">
      <!-- Left Column: Original Image with Magnifier Lens -->
      <div class="col-md-6">
        <div class="card shadow mb-4">
          
          <div class="card-body position-relative">
            <!-- Single flex container for both elements -->
            <div class="image-con">
              <!-- Original Image Container (Left Side) -->
              <div class="img-magnifier-container me-3" style="position: relative; display: inline-block;">
                <img id="original-image" src="{{ url_for('static', filename='images/sample.jpg') }}" alt="Original Image"
                     class="img-fluid" style="border:2px solid #ccc; border-radius:5px; max-width:300px;">
                <!-- The lens will be inserted here by JavaScript -->
                <div class="card-header bg-secondary text-white text-center">
                  <h5>Original Image</h5>
                </div>
              </div>
              
              <!-- Zoomed View Container (Right Side) -->
              <div class="card shadow mb-4" style="max-width: 350px;">
                <div class="card-body text-center">
                  <div id="result" class="img-zoom-result" style="width: 300px; height: 300px; margin: auto;"></div>
                </div>
                <div class="card-header bg-secondary text-white text-center">
                  <h5>Zoomed View</h5>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
      <!-- Right Column (Empty) -->
    </div>
    <!-- End Images Section -->

    <!-- Action Buttons -->
    <div class="row mt-4">
      <div class="col text-start">
        <a href="{{ url_for('robot', object_name=object_name) }}" class="btn btn-outline-secondary btn-custom">
          Quit without saving
        </a>
      </div>
    </div>
      <div class="col text-end">
        <a href="{{ url_for('index') }}" class="btn btn-outline-danger btn-custom">
          Quit &amp; Save
        </a>
      
    </div>
  </div>
</div>

<!-- Updated Magnifier JavaScript (Rendered Dimensions) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  function magnify(imgID, resultID) {
    const img = document.getElementById(imgID);
    const result = document.getElementById(resultID);

    // Remove any existing lens.
    const oldLens = document.getElementById("lens");
    if (oldLens) oldLens.remove();

    // Create lens element.
    const lens = document.createElement("div");
    lens.id = "lens";
    lens.className = "lens";
    // Insert lens into the container of the image.
    const container = img.parentElement;
    container.insertBefore(lens, img);

    let isLocked = false;

    // Toggle lock state on container click.
    container.addEventListener("click", function(e) {
      // Prevent mousemove from immediately resetting the lens after a click
      e.stopPropagation();
      isLocked = !isLocked;
      if (isLocked) {
        lens.style.border = "2px solid yellow";
        lens.style.backgroundColor = "rgba(255, 255, 0, 0.5)";
      } else {
        lens.style.border = "2px solid red";
        lens.style.backgroundColor = "rgba(255, 0, 0, 0.2)";
      }
    });

    // Calculate ratio using the offset (rendered) size of the image.
    const cx = result.offsetWidth / lens.offsetWidth;
    const cy = result.offsetHeight / lens.offsetHeight;

    result.style.backgroundImage = "url('" + img.src + "')";
    result.style.backgroundSize = (img.offsetWidth * cx) + "px " + (img.offsetHeight * cy) + "px";

    // Update lens position on mouse move.
    img.addEventListener("mousemove", moveLens);
    lens.addEventListener("mousemove", moveLens);

    function moveLens(e) {
      if (isLocked) return; // If locked, do not move the lens.
      e.preventDefault();
      const pos = getCursorPos(e);
      let x = pos.x - (lens.offsetWidth / 2);
      let y = pos.y - (lens.offsetHeight / 2);

      // Constrain lens within the visible image boundaries.
      if (x < 0) x = 0;
      if (x > img.offsetWidth - lens.offsetWidth) x = img.offsetWidth - lens.offsetWidth;
      if (y < 0) y = 0;
      if (y > img.offsetHeight - lens.offsetHeight) y = img.offsetHeight - lens.offsetHeight;

      lens.style.left = x + "px";
      lens.style.top = y + "px";

      // Update the zoomed background position.
      result.style.backgroundPosition = `-${x * cx}px -${y * cy}px`;
    }

    function getCursorPos(e) {
      const rect = img.getBoundingClientRect();
      const x = e.pageX - rect.left - window.pageXOffset;
      const y = e.pageY - rect.top - window.pageYOffset;
      return { x, y };
    }
  }

  // Initialize the magnifier.
  magnify("original-image", "result");
});
</script>
{% endblock %}
