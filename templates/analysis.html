{% extends "layout.html" %}
{% block page_heading %}Image Analysis{% endblock %}
{% block content %}
<div class="card shadow-lg mb-4 custom-card">
  <!-- Card Body -->
  <div class="card-body">
    <!-- Analysis Controls -->
    <form method="POST" class="mb-4">
      <div class="row g-3 align-items-center">
        <div class="col-md-4">
          <label for="analysis_type" class="form-label fw-bold">Select Analysis Type</label>
          <select class="form-select form-select-lg" id="analysis_type" name="analysis_type" required>
            <option value="" selected disabled>Choose analysis method</option>
            <option value="Manual">Manual Analysis</option>
            <option value="Automatic">Automatic Analysis</option>
            <option value="AI">AI Analysis</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="altitude" class="form-label fw-bold">Altitude (mm)</label>
          <input type="range" class="form-range" min="0" max="600" step="5" id="altitude" name="altitude" oninput="document.getElementById('altitude_val').innerText=this.value">
          <span id="altitude_val" class="fw-bold">300</span>
        </div>
        <div class="col-md-4">
          <label for="angle" class="form-label fw-bold">Angle (Â°)</label>
          <input type="range" class="form-range" min="0" max="80" step="5" id="angle" name="angle" oninput="document.getElementById('angle_val').innerText=this.value">
          <span id="angle_val" class="fw-bold">40</span>
        </div>
      </div>
      <div class="text-center mt-3">
        <button type="submit" class="btn btn-warning btn-custom">Start Analysis</button>
      </div>
    </form>
    <!-- End Analysis Controls -->

    <!-- Images Section: Two Parallel Columns with extra horizontal space -->
    <div class="row gx-5">
      <!-- Left Column: Original Image with Magnifier Lens -->
      <div class="col-6">
        <div class="card shadow mb-4">
          <div class="card-header bg-secondary text-white text-center">
            <h5>Original Image</h5>
          </div>
          <div class="card-body position-relative">
            <!-- Container for the image and lens -->
            <div class="img-magnifier-container" style="position: relative; display: inline-block;">
              <img id="original-image" src="{{ url_for('static', filename='images/sample.jpg') }}" alt="Original Image"
                   class="img-fluid" style="border:2px solid #ccc; border-radius:5px; max-width:300px;">
              <!-- The lens will be inserted here by JavaScript -->
            </div>
          </div>
        </div>
      </div>
      <!-- Right Column: Fixed Zoomed View -->
      <div class="col-6">
        <div class="card shadow mb-4">
          <div class="card-header bg-secondary text-white text-center">
            <h5>Zoomed View</h5>
          </div>
          <div class="card-body text-center">
            <div id="result" class="img-zoom-result"></div>
            <p class="mt-2 text-muted">
              Move your cursor over the original image.<br>
              Click anywhere in the image area to toggle lock on the lens (yellow = locked).
            </p>
          </div>
        </div>
      </div>
    </div>
    <!-- End Images Section -->

    <!-- Action Buttons -->
    <div class="row mt-4">
      <div class="col text-start">
        <a href="{{ url_for('robot', object_name=object_name) }}" class="btn btn-outline-secondary btn-custom">Quit without saving</a>
      </div>
      <div class="col text-end">
        <a href="{{ url_for('index') }}" class="btn btn-outline-danger btn-custom">Quit &amp; Save</a>
      </div>
    </div>
  </div>
</div>

<!-- Magnifier JavaScript (unchanged) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  function magnify(imgID, resultID) {
    const img = document.getElementById(imgID);
    const result = document.getElementById(resultID);

    // Remove any existing lens.
    const oldLens = document.getElementById("lens");
    if (oldLens) oldLens.remove();

    // Create lens element.
    const lens = document.createElement("div");
    lens.id = "lens";
    lens.className = "lens";
    // Insert lens into the container of the image.
    const container = img.parentElement;
    container.insertBefore(lens, img);

    let isLocked = false;

    // Toggle lock state on container click.
    container.addEventListener("click", function(e) {
      e.stopPropagation();
      isLocked = !isLocked;
      if (isLocked) {
        lens.style.border = "2px solid yellow";
        lens.style.backgroundColor = "rgba(255, 255, 0, 0.5)";
      } else {
        lens.style.border = "2px solid red";
        lens.style.backgroundColor = "rgba(255, 0, 0, 0.2)";
      }
    });

    const cx = result.offsetWidth / lens.offsetWidth;
    const cy = result.offsetHeight / lens.offsetHeight;

    result.style.backgroundImage = "url('" + img.src + "')";
    result.style.backgroundSize = (img.width * cx) + "px " + (img.height * cy) + "px";

    img.addEventListener("mousemove", moveLens);
    lens.addEventListener("mousemove", moveLens);

    function moveLens(e) {
      if (isLocked) return;
      e.preventDefault();
      const pos = getCursorPos(e);
      let x = pos.x - (lens.offsetWidth / 2);
      let y = pos.y - (lens.offsetHeight / 2);
      if (x < 0) x = 0;
      if (x > img.width - lens.offsetWidth) x = img.width - lens.offsetWidth;
      if (y < 0) y = 0;
      if (y > img.height - lens.offsetHeight) y = img.height - lens.offsetHeight;
      lens.style.left = x + "px";
      lens.style.top = y + "px";
      result.style.backgroundPosition = `-${x * cx}px -${y * cy}px`;
    }

    function getCursorPos(e) {
      const rect = img.getBoundingClientRect();
      const x = e.pageX - rect.left - window.pageXOffset;
      const y = e.pageY - rect.top - window.pageYOffset;
      return { x, y };
    }
  }

  magnify("original-image", "result");
});
</script>
{% endblock %}
